# 排行榜服务 (Leaderboard Service)

## 项目概述
排行榜服务是一个通用的排名系统，可以为各类应用场景提供实时的排名数据服务。支持多种排行榜类型，确保数据的实时性和准确性。

## 功能需求

### 1. 基础排行榜功能
- 支持创建多个排行榜
- 支持实时更新分数
- 支持查询指定用户排名
- 支持查询排行榜前N名
- 支持分页查询排行榜数据
- 支持查询指定用户周边排名

### 2. 高级特性
- 支持多维度排序（如：分数、时间等）
- 支持排行榜数据定时重置（每日/每周/每月）
- 支持历史排行榜数据查询
- 支持排行榜数据变化趋势分析
- 支持自定义排名规则
- 支持定时排行榜（在特定时间点进行结算和排名）

### 3. 管理功能
- 排行榜的创建、修改、删除
- 排行榜数据的手动重置
- 异常数据处理
- 数据统计和分析

## 技术需求

### 1. 性能要求
- 支持高并发读写
- 毫秒级的响应时间
- 数据实时更新
- 系统高可用性（99.99%）

### 2. 扩展性要求
- 支持水平扩展
- 模块化设计，便于功能扩展

### 3. 安全要求
- 数据访问权限控制
- 防作弊机制
- 数据加密传输
- 操作日志记录

### 4. 接口要求
- 提供RESTful API
- 支持批量操作接口
- 提供SDK（可选）
- 完善的接口文档

## 技术选型建议
- 后端：Python/FastAPI
- 数据库：Redis (实时排行榜数据)、S3 (历史数据存储)
- 消息队列：Redis Pub/Sub
- API文档：Swagger
- 监控：Prometheus + Grafana

## 功能实现
本项目的核心功能通过以下方式实现：

1. 数据存储：
   - 使用Redis作为主要数据存储，利用其有序集合（Sorted Set）特性实现高效的排行榜功能。
   - 对于历史数据，使用S3对象存储服务，定期将数据归档以便后续分析。

2. API实现：
   - 使用FastAPI框架构建RESTful API，提供高性能的异步处理能力。
   - 实现了创建排行榜、更新分数、查询排名等核心API。

3. 实时更新：
   - 利用Redis的Pub/Sub机制实现实时数据更新，确保排行榜数据的及时性。

4. 数据一致性：
   - 使用Redis的事务功能确保数据更新的原子性。
   - 实现了乐观锁机制，处理并发更新场景。

5. 性能优化：
   - 使用Redis的pipeline功能批量处理操作，减少网络往返。
   - 实现了缓存层，减少对Redis的直接访问，提高响应速度。

6. 扩展性：
   - 采用模块化设计，便于添加新的排行榜类型和规则。
   - 使用配置文件管理系统参数，便于动态调整和扩展。

7. 安全性：
   - 实现了基于JWT的身份验证和授权机制。
   - 使用HTTPS加密所有API通信。
   - 实现了请求频率限制，防止API滥用。

8. 监控和日志：
   - 集成了Prometheus进行系统监控，使用Grafana进行可视化。
   - 实现了详细的日志记录，包括操作日志和错误日志，便于问题诊断和系统优化。

9. 定时排行榜：
   - 实现了在特定时间点进行结算和排名的定时排行榜功能。
   - 支持配置不同的结算周期（每日、每周、每月）。
   - 提供了手动结算功能，允许管理员在需要时触发结算。
   - 保存历史排行榜数据，支持查询过去的排行榜结果。

通过这些实现方式，我们确保了排行榜服务的高性能、可靠性和可扩展性，能够满足各种复杂的排行榜需求，包括实时排行榜和定时结算的排行榜。

## 后续规划
- 支持更多数据分析功能
- 开发配套的管理后台

## 安装和启动

### 安装依赖
确保你已经安装了 Python 3.7 或更高版本。然后，在项目根目录下运行以下命令安装依赖：

```
pip install -r requirements.txt
```

### 配置
1. 在项目根目录下创建一个 `.env` 文件。
2. 根据 `.env.example` 文件的格式，填写必要的配置信息。

### 启动服务
在项目根目录下运行以下命令启动服务：

```
uvicorn main:app --reload
```

这个命令会启动开发服务器，并在代码变更时自动重新加载。

对于生产环境，你可以使用以下命令：

```
uvicorn main:app --host 0.0.0.0 --port 8000
```

服务将在指定的主机和端口上运行。默认情况下，你可以通过访问 `http://localhost:8000` 来使用 API。

API 文档可以在 `http://localhost:8000/docs` 查看。

注意：确保你的 .env 文件中配置了正确的 API_HOST 和 API_PORT。

## 运行测试

本项目使用pytest进行单元测试。要运行测试，请按照以下步骤操作：

1. 确保你已经安装了所有的依赖，包括测试依赖：

```
pip install -r requirements.txt
```

2. 在项目根目录下运行以下命令来执行所有测试：

```
pytest
```

这将运行所有的测试文件，包括：
- leaderboard_test.py
- storage_test.py
- api/routes_test.py
- api/scheduled_leaderboard_api_test.py

3. 如果你想运行特定的测试文件，可以指定文件路径：

```
pytest path/to/test_file.py
```

例如，要只运行leaderboard_test.py，可以使用：

```
pytest leaderboard_test.py
```

4. 要查看更详细的测试输出，可以添加 -v 参数：

```
pytest -v
```

这将显示每个测试用例的结果。

确保在运行测试之前，你的开发环境（如Redis）已经正确设置。某些测试可能需要模拟外部依赖，我们使用了mock对象来处理这些情况。

如果你遇到任何测试失败的情况，请检查错误信息并相应地调试代码。如果你对测试有任何疑问或需要添加新的测试，请参考现有的测试文件作为示例。
